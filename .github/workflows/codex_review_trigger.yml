name: Codex Review Trigger

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

jobs:
  request-codex-review:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    concurrency:
      group: codex-review-${{ github.event.workflow_run.id }}
      cancel-in-progress: false
    steps:
      - name: Request Codex review on PR
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const pr = run.pull_requests?.[0];
            if (!pr) {
              core.info('Skip posting: workflow_run has no associated pull request.');
              return;
            }
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = `<!-- codex-review-trigger:workflow-run-id=${run.id} -->`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100
            });

            const alreadyPosted = comments.some((comment) => comment.body && comment.body.includes(marker));
            if (alreadyPosted) {
              core.info(`Skip posting: marker already exists for workflow_run.id=${run.id}`);
              return;
            }

            const body = [
              '@codex review',
              '',
              'CI passed. Please review this PR update.',
              `- Commit: \`${run.head_sha}\``,
              `- Test run: ${run.html_url}`,
              '',
              marker
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body
            });
