name: Codex Review Trigger

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to comment on (for manual verification)"
        required: false
      head_sha:
        description: "Head commit SHA to associate with this review request"
        required: false

jobs:
  request-codex-review:
    if: ${{ github.event_name == 'workflow_dispatch' || !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write
      pull-requests: write
    concurrency:
      group: codex-review-pr-${{ github.event.pull_request.number || inputs.pr_number }}-${{ github.event.pull_request.head.sha || inputs.head_sha }}
      cancel-in-progress: false
    steps:
      - name: Request Codex review on PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let prNumber;
            let headSha;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = Number(context.payload.inputs?.pr_number);
              headSha = context.payload.inputs?.head_sha?.trim();
              if (!prNumber || !headSha) {
                core.setFailed('workflow_dispatch requires both inputs: pr_number and head_sha');
                return;
              }
            } else {
              const pr = context.payload.pull_request;
              prNumber = pr.number;
              headSha = pr.head.sha;
            }

            const maxAttempts = 40; // 10 minutes with 15s interval
            const waitMs = 15000;
            let matchedRun = null;

            for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
              const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
                owner,
                repo,
                workflow_id: 'test.yml',
                event: 'pull_request',
                per_page: 100
              });

              matchedRun = runs.find((run) => run.head_sha === headSha);
              if (matchedRun && matchedRun.status === 'completed') {
                break;
              }

              core.info(`Waiting for Test workflow completion for sha=${headSha} (attempt ${attempt}/${maxAttempts})`);
              await new Promise((resolve) => setTimeout(resolve, waitMs));
            }

            if (!matchedRun || matchedRun.status !== 'completed') {
              core.setFailed(`Timed out waiting for Test workflow completion for sha=${headSha}`);
              return;
            }

            if (matchedRun.conclusion !== 'success') {
              core.info(`Skip posting: Test workflow conclusion is ${matchedRun.conclusion} for sha=${headSha}`);
              return;
            }

            const marker = `<!-- codex-review-trigger:sha=${headSha} -->`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });

            const alreadyPosted = comments.some((comment) => comment.body && comment.body.includes(marker));
            if (alreadyPosted) {
              core.info(`Skip posting: marker already exists for sha=${headSha}`);
              return;
            }

            const body = [
              '@codex review',
              '',
              'CI passed. Please review this PR update.',
              `- Commit: \`${headSha}\``,
              `- Test run: ${matchedRun.html_url}`,
              '',
              marker
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body
            });
